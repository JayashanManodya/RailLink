<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Bookings Management - RailLink</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #030304;
            color: #FFFFFF;
        }
        
        .admin-card {
            background-color: rgba(24, 24, 29, 0.8);
            border: 1px solid #18181D;
            transition: all 0.3s ease;
        }
        
        .admin-card:hover {
            background-color: rgba(24, 24, 29, 0.9);
            border-color: #BDEB29;
        }
        
        .btn-primary {
            background-color: #BDEB29;
            color: #030304;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #8CA43F;
            color: #FFFFFF;
        }
        
        .btn-secondary {
            background-color: transparent;
            border: 1px solid #848484;
            color: #848484;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            border-color: #FFFFFF;
            color: #FFFFFF;
        }
        
        .status-confirmed {
            background-color: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .status-cancelled {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .status-pending {
            background-color: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
    </style>
</head>
<body>
    
    <header style="background-color: rgba(24, 24, 29, 0.9);" class="fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                
                <a href="/" class="flex items-center space-x-2 text-xl font-bold" style="color: #FFFFFF;">
                    <i data-lucide="train-front" class="h-6 w-6" style="color: #BDEB29;"></i>
                    <span>RailLink</span>
                </a>
                
                
                <nav class="hidden md:flex space-x-8">
                    <a href="/" class="transition duration-150" style="color: #848484;" onmouseover="this.style.color='#FFFFFF'" onmouseout="this.style.color='#848484'">Home</a>
                    <a href="/dashboard" class="transition duration-150" style="color: #848484;" onmouseover="this.style.color='#FFFFFF'" onmouseout="this.style.color='#848484'">Dashboard</a>
                    <a href="/search-trains" class="transition duration-150" style="color: #848484;" onmouseover="this.style.color='#FFFFFF'" onmouseout="this.style.color='#848484'">Search Trains</a>
                    <a href="/help" class="transition duration-150" style="color: #848484;" onmouseover="this.style.color='#FFFFFF'" onmouseout="this.style.color='#848484'">Help</a>
                </nav>
                
                
                <div class="flex items-center space-x-4">
                    <div th:if="${isStaffView}" class="flex items-center space-x-2">
                        <a href="/staff/dashboard" class="px-4 py-2 rounded-lg font-semibold transition duration-150" style="color: #BDEB29; border: 1px solid #BDEB29;" onmouseover="this.style.color='#FFFFFF'; this.style.borderColor='#FFFFFF'" onmouseout="this.style.color='#BDEB29'; this.style.borderColor='#BDEB29'">
                            <i data-lucide="briefcase" class="inline h-4 w-4 mr-2"></i>
                            Staff Dashboard
                        </a>
                    </div>
                    <div th:unless="${isStaffView}" class="flex items-center space-x-2">
                        <a href="/admin/dashboard" class="px-4 py-2 rounded-lg font-semibold transition duration-150" style="color: #BDEB29; border: 1px solid #BDEB29;" onmouseover="this.style.color='#FFFFFF'; this.style.borderColor='#FFFFFF'" onmouseout="this.style.color='#BDEB29'; this.style.borderColor='#BDEB29'">
                            <i data-lucide="shield" class="inline h-4 w-4 mr-2"></i>
                            Admin Dashboard
                        </a>
                    </div>
                    <a href="/logout" class="px-4 py-2 rounded-lg font-semibold transition duration-150" style="background-color: #BDEB29; color: #030304;" onmouseover="this.style.backgroundColor='#8CA43F'; this.style.color='#FFFFFF'" onmouseout="this.style.backgroundColor='#BDEB29'; this.style.color='#030304'">
                        <i data-lucide="log-out" class="inline h-4 w-4 mr-2"></i>
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </header>

    
    <div class="pt-20 min-h-screen" style="background-color: #030304;">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <div th:if="${success}" class="mb-6 p-4 rounded-lg" style="background-color: #10b981; color: #FFFFFF;">
                <div class="flex items-center gap-2">
                    <i data-lucide="check-circle" class="h-5 w-5"></i>
                    <span th:text="${success}"></span>
                </div>
            </div>
            <div th:if="${error}" class="mb-6 p-4 rounded-lg" style="background-color: #ef4444; color: #FFFFFF;">
                <div class="flex items-center gap-2">
                    <i data-lucide="alert-circle" class="h-5 w-5"></i>
                    <span th:text="${error}"></span>
                </div>
            </div>

            
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold mb-2" style="color: #FFFFFF;">Bookings Management</h1>
                    <p class="text-lg" style="color: #848484;">View and manage passenger bookings</p>
                    
                </div>
                <div class="flex space-x-4">
                    <button onclick="toggleCreateBookingForm()" class="btn-primary inline-flex items-center px-4 py-2 rounded-lg font-semibold">
                        <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                        Create New Booking
                    </button>
                    <div th:unless="${isStaffView}">
                        <a href="/admin/dashboard" class="btn-secondary inline-flex items-center px-4 py-2 rounded-lg font-semibold">
                            <i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>
                            Back to Dashboard
                        </a>
                    </div>
                    <div th:if="${isStaffView}">
                        <a href="/staff/dashboard" class="btn-secondary inline-flex items-center px-4 py-2 rounded-lg font-semibold">
                            <i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>
                            Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            
            <!-- Search and Filter Section -->
            <div class="admin-card rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4" style="color: #FFFFFF;">
                    <i data-lucide="search" class="inline h-6 w-6 mr-2" style="color: #BDEB29;"></i>
                    Search & Filter Bookings
                </h2>
                <form th:action="@{/admin/bookings}" method="get" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="passenger" class="block text-sm font-medium mb-2" style="color: #FFFFFF;">Passenger Name</label>
                        <input type="text" id="passenger" name="passenger" th:value="${param.passenger}" 
                               placeholder="Enter passenger name or email"
                               class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-gray-800 text-white focus:border-[#BDEB29] focus:ring-2 focus:ring-[#BDEB29] focus:outline-none">
                    </div>
                    <div>
                        <label for="bookingId" class="block text-sm font-medium mb-2" style="color: #FFFFFF;">Booking ID</label>
                        <input type="text" id="bookingId" name="bookingId" th:value="${param.bookingId}" 
                               placeholder="Enter booking ID"
                               class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-gray-800 text-white focus:border-[#BDEB29] focus:ring-2 focus:ring-[#BDEB29] focus:outline-none">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="btn-primary w-full px-4 py-2 rounded-lg font-semibold inline-flex items-center justify-center">
                            <i data-lucide="search" class="h-4 w-4 mr-2"></i>
                            Search
                        </button>
                    </div>
                </form>
                <div th:if="${param.passenger != null or param.bookingId != null}" class="mt-4">
                    <a href="/admin/bookings" class="btn-secondary inline-flex items-center px-4 py-2 rounded-lg font-semibold">
                        <i data-lucide="x" class="h-4 w-4 mr-2"></i>
                        Clear Filters
                    </a>
                </div>
            </div>

            <!-- Create New Booking Form (Hidden by default) -->
            <div id="createBookingForm" class="admin-card rounded-xl p-6 mb-6" style="display: none;">
                <h2 class="text-2xl font-semibold mb-4" style="color: #FFFFFF;">
                    <i data-lucide="plus-circle" class="inline h-6 w-6 mr-2" style="color: #BDEB29;"></i>
                    Create New Booking
                </h2>
                <form th:action="@{/admin/bookings/create}" method="post" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Passenger Selection -->
                        <div>
                            <label for="passengerId" class="block text-sm font-medium mb-2" style="color: #FFFFFF;">Select Passenger</label>
                            <select id="passengerId" name="passengerId" required
                                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-gray-800 text-white focus:border-[#BDEB29] focus:ring-2 focus:ring-[#BDEB29] focus:outline-none">
                                <option value="">Choose a passenger...</option>
                                <option th:each="user : ${users}" 
                                        th:value="${user.id}" 
                                        th:text="${user.username + ' (' + user.email + ')'}">
                                    john_doe (john@example.com)
                                </option>
                            </select>
                        </div>

                        <!-- Schedule Selection -->
                        <div>
                            <label for="scheduleId" class="block text-sm font-medium mb-2" style="color: #FFFFFF;">Select Schedule</label>
                            <select id="scheduleId" name="scheduleId" required
                                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-gray-800 text-white focus:border-[#BDEB29] focus:ring-2 focus:ring-[#BDEB29] focus:outline-none">
                                <option value="">Choose a schedule...</option>
                                <option th:each="schedule : ${schedules}" 
                                        th:value="${schedule.id}" 
                                        th:text="${schedule.train.name + ' - ' + schedule.route.name + ' (' + #temporals.format(schedule.departureDate, 'MMM dd, yyyy HH:mm') + ')'}">
                                    Express Train - Colombo to Kandy (Dec 15, 2024 08:30)
                                </option>
                            </select>
                        </div>

                        <!-- Seat Number -->
                        <div>
                            <label for="seatNumber" class="block text-sm font-medium mb-2" style="color: #FFFFFF;">Seat Number</label>
                            <input type="text" id="seatNumber" name="seatNumber" required
                                   placeholder="Enter seat number (e.g., A12, 15)"
                                   class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-gray-800 text-white focus:border-[#BDEB29] focus:ring-2 focus:ring-[#BDEB29] focus:outline-none">
                        </div>

                        <!-- Ticket Class -->
                        <div>
                            <label for="ticketClass" class="block text-sm font-medium mb-2" style="color: #FFFFFF;">Ticket Class</label>
                            <select id="ticketClass" name="ticketClass"
                                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-gray-800 text-white focus:border-[#BDEB29] focus:ring-2 focus:ring-[#BDEB29] focus:outline-none">
                                <option value="">Select class...</option>
                                <option value="First Class">First Class</option>
                                <option value="Second Class">Second Class</option>
                                <option value="Third Class">Third Class</option>
                            </select>
                        </div>

                        <!-- Status -->
                        <div>
                            <label for="status" class="block text-sm font-medium mb-2" style="color: #FFFFFF;">Booking Status</label>
                            <select id="status" name="status" required
                                    class="w-full px-4 py-2 rounded-lg border border-gray-600 bg-gray-800 text-white focus:border-[#BDEB29] focus:ring-2 focus:ring-[#BDEB29] focus:outline-none">
                                <option value="CONFIRMED">Confirmed</option>
                                <option value="PENDING">Pending</option>
                                <option value="CANCELLED">Cancelled</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="toggleCreateBookingForm()" 
                                class="btn-secondary px-6 py-2 rounded-lg font-semibold">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary px-6 py-2 rounded-lg font-semibold">
                            <i data-lucide="save" class="inline h-4 w-4 mr-2"></i>
                            Create Booking
                        </button>
                    </div>
                </form>
            </div>

            <div class="admin-card rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold" style="color: #FFFFFF;">All Bookings</h2>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm" style="color: #848484;">
                            Total: <span th:text="${#lists.size(bookings)}">0</span> bookings
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b" style="border-color: #18181D;">
                                <th class="text-left py-3 px-4 font-semibold" style="color: #FFFFFF;">Booking ID</th>
                                <th class="text-left py-3 px-4 font-semibold" style="color: #FFFFFF;">Passenger</th>
                                <th class="text-left py-3 px-4 font-semibold" style="color: #FFFFFF;">Train</th>
                                <th class="text-left py-3 px-4 font-semibold" style="color: #FFFFFF;">Route</th>
                                <th class="text-left py-3 px-4 font-semibold" style="color: #FFFFFF;">Seat</th>
                                <th class="text-left py-3 px-4 font-semibold" style="color: #FFFFFF;">Departure</th>
                                <th class="text-left py-3 px-4 font-semibold" style="color: #FFFFFF;">Status</th>
                                <th class="text-left py-3 px-4 font-semibold" style="color: #FFFFFF;">Fare</th>
                                <th class="text-left py-3 px-4 font-semibold" style="color: #FFFFFF;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="booking : ${bookings}" class="border-b" style="border-color: #18181D;">
                                <td class="py-3 px-4" style="color: #FFFFFF;">
                                    <span class="font-mono text-sm">#<span th:text="${booking.id}">123</span></span>
                                </td>
                                <td class="py-3 px-4" style="color: #FFFFFF;">
                                    <div>
                                        <div class="font-semibold" th:text="${booking.user.username}">john_doe</div>
                                        <div class="text-sm" style="color: #848484;" th:text="${booking.user.email}">john@example.com</div>
                                    </div>
                                </td>
                                <td class="py-3 px-4" style="color: #FFFFFF;">
                                    <span th:text="${booking.schedule.train.name}">Express Train</span>
                                </td>
                                <td class="py-3 px-4" style="color: #FFFFFF;">
                                    <span th:text="${booking.schedule.route.name}">Colombo to Kandy</span>
                                </td>
                                <td class="py-3 px-4" style="color: #FFFFFF;">
                                    <span class="font-mono" th:text="${booking.seatNumber}">A12</span>
                                </td>
                                <td class="py-3 px-4" style="color: #FFFFFF;">
                                    <div>
                                        <div th:text="${#temporals.format(booking.schedule.departureDate, 'MMM dd, yyyy')}">Dec 15, 2024</div>
                                        <div class="text-sm" style="color: #848484;" th:text="${#temporals.format(booking.schedule.departureDate, 'HH:mm')}">08:30</div>
                                    </div>
                                </td>
                                <td class="py-3 px-4">
                                    <span th:classappend="${booking.status == 'CONFIRMED'} ? 'status-confirmed' : (${booking.status == 'CANCELLED'} ? 'status-cancelled' : 'status-pending')" 
                                          class="px-3 py-1 rounded-full text-sm font-semibold" th:text="${booking.status}">CONFIRMED</span>
                                </td>
                                <td class="py-3 px-4" style="color: #FFFFFF;">
                                    <span class="font-semibold">LKR <span th:text="${#numbers.formatDecimal(booking.fare, 1, 2)}">1,250.00</span></span>
                                </td>
                                <td class="py-3 px-4">
                                    <div class="flex space-x-2">
                                        <a th:href="@{/admin/bookings/edit/{id}(id=${booking.id})}" 
                                           class="btn-secondary px-3 py-1 rounded text-sm inline-flex items-center">
                                            <i data-lucide="edit" class="h-3 w-3 mr-1"></i>
                                            Edit
                                        </a>
                                        <button th:if="${booking.status == 'CONFIRMED'}" 
                                                class="btn-secondary px-3 py-1 rounded text-sm inline-flex items-center"
                                                th:onclick="'cancelBooking(' + ${booking.id} + ')'">
                                            <i data-lucide="x" class="h-3 w-3 mr-1"></i>
                                            Cancel
                                        </button>
                                        <button class="px-3 py-1 rounded text-sm inline-flex items-center"
                                                style="background-color: #ef4444; color: #FFFFFF;"
                                                onmouseover="this.style.backgroundColor='#dc2626'"
                                                onmouseout="this.style.backgroundColor='#ef4444'"
                                                th:onclick="'deleteBooking(' + ${booking.id} + ')'">
                                            <i data-lucide="trash-2" class="h-3 w-3 mr-1"></i>
                                            Delete
                                        </button>
                                        <a th:href="@{/bookings/{id}/ticket(id=${booking.id})}" 
                                           class="btn-primary px-3 py-1 rounded text-sm inline-flex items-center">
                                            <i data-lucide="ticket" class="h-3 w-3 mr-1"></i>
                                            Ticket
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div th:if="${#lists.isEmpty(bookings)}" class="text-center py-12">
                    <div class="p-4 rounded-full inline-block" style="background-color: rgba(189, 235, 41, 0.1);">
                        <i data-lucide="ticket" class="h-8 w-8" style="color: #BDEB29;"></i>
                    </div>
                    <h3 class="text-xl font-semibold mt-4 mb-2" style="color: #FFFFFF;">No Bookings Found</h3>
                    <p style="color: #848484;">There are no bookings to display at the moment.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Test JavaScript function
        function testJavaScript() {
            console.log('=== TEST JAVASCRIPT FUNCTION CALLED ===');
            alert('JavaScript is working! Check console for details.');
            console.log('JavaScript test successful');
        }

        // Cancel booking function
        function cancelBooking(bookingId) {
            console.log('=== CANCEL BOOKING FUNCTION CALLED ===');
            console.log('Cancel booking clicked for ID:', bookingId);
            console.log('Booking ID type:', typeof bookingId);
            console.log('Booking ID value:', bookingId);
            
            if (confirm('Are you sure you want to cancel this booking?')) {
                console.log('User confirmed cancellation, redirecting to:', `/admin/bookings/cancel/${bookingId}`);
                window.location.href = `/admin/bookings/cancel/${bookingId}`;
            } else {
                console.log('User cancelled the action');
            }
        }

        // Delete booking function (permanent deletion)
        function deleteBooking(bookingId) {
            console.log('=== DELETE BOOKING FUNCTION CALLED ===');
            console.log('Delete booking clicked for ID:', bookingId);
            console.log('Booking ID type:', typeof bookingId);
            console.log('Booking ID value:', bookingId);
            
            if (confirm('Are you sure you want to PERMANENTLY DELETE this booking? This action cannot be undone and will remove the booking from the database.')) {
                console.log('First confirmation passed');
                if (confirm('This will permanently delete the booking from the database. Are you absolutely sure?')) {
                    console.log('Second confirmation passed');
                    const deleteUrl = `/admin/bookings/delete/${bookingId}`;
                    console.log('Redirecting to:', deleteUrl);
                    window.location.href = deleteUrl;
                } else {
                    console.log('User cancelled the permanent deletion (second confirmation)');
                }
            } else {
                console.log('User cancelled the deletion (first confirmation)');
            }
        }

        // Toggle create booking form
        function toggleCreateBookingForm() {
            const form = document.getElementById('createBookingForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }


        // Debug function to check if buttons are properly rendered
        window.addEventListener('load', function() {
            console.log('=== PAGE LOADED ===');
            console.log('Total bookings on page:', document.querySelectorAll('tr').length - 1); // -1 for header row
            
            // Check if cancel buttons exist
            const cancelButtons = document.querySelectorAll('button[onclick*="cancelBooking"]');
            console.log('Cancel buttons found:', cancelButtons.length);
            
            // Check if delete buttons exist
            const deleteButtons = document.querySelectorAll('button[onclick*="deleteBooking"]');
            console.log('Delete buttons found:', deleteButtons.length);
            
            // Log all buttons with onclick attributes
            const allButtons = document.querySelectorAll('button[onclick]');
            console.log('All buttons with onclick:', allButtons.length);
            allButtons.forEach((btn, index) => {
                console.log(`Button ${index}:`, btn.onclick.toString());
            });
        });
    </script>
</body>
</html>
