<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Booking Confirmed - RailLink</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #030304;
            color: #FFFFFF;
        }
        
        .ticket-card {
            background: linear-gradient(135deg, #1a1a1f 0%, #2d2d35 100%);
            border: 2px solid #BDEB29;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .ticket-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #BDEB29, #8CA43F, #BDEB29);
        }
        
        .ticket-header {
            background: linear-gradient(135deg, #BDEB29, #8CA43F);
            color: #030304;
            border-radius: 18px 18px 0 0;
        }
        
        .ticket-body {
            background: linear-gradient(135deg, #1a1a1f 0%, #2d2d35 100%);
        }
        
        .ticket-footer {
            background: linear-gradient(135deg, #2d2d35 0%, #1a1a1f 100%);
            border-radius: 0 0 18px 18px;
        }
        
        .btn-primary {
            background-color: #BDEB29;
            color: #030304;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #8CA43F;
            color: #FFFFFF;
        }
        
        .btn-secondary {
            background-color: transparent;
            border: 1px solid #848484;
            color: #848484;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            border-color: #FFFFFF;
            color: #FFFFFF;
        }
        
        .btn-print {
            background-color: #3b82f6;
            color: #FFFFFF;
            transition: all 0.3s ease;
        }
        
        .btn-print:hover {
            background-color: #2563eb;
        }
        
        .ticket-qr {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 8px;
            display: inline-block;
        }
        
        .ticket-dashed-line {
            border-top: 2px dashed #BDEB29;
            margin: 20px 0;
        }
        
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            body {
                background: white !important;
                color: black !important;
                margin: 0 !important;
                padding: 20px !important;
            }
            
            .ticket-card {
                background: white !important;
                border: 2px solid black !important;
                box-shadow: none !important;
                page-break-inside: avoid !important;
                margin: 0 !important;
                max-width: none !important;
            }
            
            .ticket-header {
                background: #f0f0f0 !important;
                color: black !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            .ticket-body {
                background: white !important;
                color: black !important;
            }
            
            .ticket-footer {
                background: #f0f0f0 !important;
                color: black !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .btn-primary, .btn-secondary, .btn-print {
                display: none !important;
            }
            
            /* Ensure text is visible */
            h1, h2, h3, p, span, div {
                color: black !important;
            }
            
            /* Print-specific styles */
            @page {
                margin: 0.5in;
                size: A4;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-4xl">
        
        <div class="text-center mb-8 no-print">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-4" style="background-color: rgba(34, 197, 94, 0.1); border: 2px solid #22c55e;">
                <i data-lucide="check-circle" class="h-10 w-10" style="color: #22c55e;"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2" style="color: #FFFFFF;">Booking Confirmed!</h1>
            <p class="text-lg" style="color: #848484;">Your train ticket has been successfully booked</p>
        </div>

        
        <div class="ticket-card" id="ticket">
            
            <div class="ticket-header p-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="train-front" class="h-8 w-8"></i>
                        <div>
                            <h1 class="text-2xl font-bold">RailLink</h1>
                            <p class="text-sm opacity-80">Digital Train Ticket</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm opacity-80">Booking ID</div>
                        <div class="text-xl font-bold" th:text="'#' + ${booking.id}">#12345</div>
                    </div>
                </div>
            </div>

            
            <div class="ticket-body p-6">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    
                    <div class="text-center">
                        <div class="text-sm opacity-70 mb-2">FROM</div>
                        <div class="text-lg font-semibold" th:text="${#strings.substring(booking.schedule.route.name, 0, #strings.indexOf(booking.schedule.route.name, ' to '))}">Colombo Fort</div>
                        <div class="text-sm opacity-70" th:text="${#temporals.format(booking.schedule.departureDate, 'MMM dd, yyyy')}">Dec 15, 2024</div>
                        <div class="text-lg font-bold" th:text="${#temporals.format(booking.schedule.departureDate, 'HH:mm')}">08:30</div>
                    </div>

                    
                    <div class="flex items-center justify-center">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-0.5 bg-current opacity-50"></div>
                            <i data-lucide="train" class="h-6 w-6"></i>
                            <div class="w-8 h-0.5 bg-current opacity-50"></div>
                        </div>
                    </div>

                    
                    <div class="text-center">
                        <div class="text-sm opacity-70 mb-2">TO</div>
                        <div class="text-lg font-semibold" th:text="${#strings.substring(booking.schedule.route.name, #strings.indexOf(booking.schedule.route.name, ' to ') + 4)}">Kandy</div>
                        <div class="text-sm opacity-70" th:text="${#temporals.format(booking.schedule.arrivalDate, 'MMM dd, yyyy')}">Dec 15, 2024</div>
                        <div class="text-lg font-bold" th:text="${#temporals.format(booking.schedule.arrivalDate, 'HH:mm')}">11:00</div>
                    </div>
                </div>

                
                <div class="ticket-dashed-line"></div>

                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="space-y-4">
                        <div>
                            <div class="text-sm opacity-70 mb-1">PASSENGER</div>
                            <div class="text-lg font-semibold" th:text="${booking.user.username}">John Doe</div>
                        </div>
                        <div>
                            <div class="text-sm opacity-70 mb-1">TICKET CLASS</div>
                            <div class="text-lg font-semibold" th:text="${ticketClass != null ? ticketClass : 'Standard'}">
                                <i data-lucide="star" class="inline h-4 w-4 mr-1"></i>
                                <span>First Class</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm opacity-70 mb-1">NUMBER OF TICKETS</div>
                            <div class="text-lg font-semibold">
                                <i data-lucide="ticket" class="inline h-4 w-4 mr-1"></i>
                                <span th:text="${ticketCount != null ? ticketCount : 1} + ' ticket(s)'">1 ticket(s)</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm opacity-70 mb-1">SEAT NUMBER(S)</div>
                            <div class="text-lg font-semibold">
                                <i data-lucide="armchair" class="inline h-4 w-4 mr-1"></i>
                                <span th:text="${seatNumbers != null ? #strings.listJoin(seatNumbers, ', ') : booking.seatNumber}">A12</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm opacity-70 mb-1">TRAIN</div>
                            <div class="text-lg font-semibold" th:text="${booking.schedule.train.name}">Express Train</div>
                        </div>
                    </div>

                    
                    <div class="space-y-4">
                        <div>
                            <div class="text-sm opacity-70 mb-1">STATUS</div>
                            <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold" 
                                 style="background-color: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid #22c55e;"
                                 th:text="${booking.status}">CONFIRMED</div>
                        </div>
                        <div>
                            <div class="text-sm opacity-70 mb-1">PRICE PER TICKET</div>
                            <div class="text-lg font-semibold">
                                Rs. <span th:text="${booking.fare != null ? #numbers.formatDecimal(booking.fare, 0, 2) : '0.00'}">25.00</span>
                            </div>
                        </div>
                        <div th:if="${ticketCount != null and ticketCount > 1}" class="p-3 rounded-lg" style="background-color: rgba(189, 235, 41, 0.1); border: 2px solid #BDEB29;">
                            <div class="text-sm opacity-70 mb-1">TOTAL FARE</div>
                            <div class="text-2xl font-bold" style="color: #BDEB29;">
                                Rs. <span th:text="${totalFare != null ? #numbers.formatDecimal(totalFare, 0, 2) : '0.00'}">75.00</span>
                            </div>
                            <div class="text-xs opacity-70 mt-1">
                                <span th:text="${ticketCount} + ' × Rs. ' + ${#numbers.formatDecimal(booking.fare, 0, 2)}">3 × Rs. 25.00</span>
                            </div>
                        </div>
                        <div th:if="${ticketCount == null or ticketCount == 1}">
                            <div class="text-sm opacity-70 mb-1">TOTAL FARE</div>
                            <div class="text-2xl font-bold" style="color: #BDEB29;">
                                Rs. <span th:text="${booking.fare != null ? #numbers.formatDecimal(booking.fare, 0, 2) : '0.00'}">25.00</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm opacity-70 mb-1">BOOKING DATE</div>
                            <div class="text-lg font-semibold" th:text="${#temporals.format(booking.bookingDate, 'MMM dd, yyyy HH:mm')}">Dec 14, 2024 15:30</div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="ticket-footer p-6">
            </div>
        </div>

        
        <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8 no-print">
            <button onclick="downloadPDF()" class="btn-primary px-8 py-3 rounded-lg font-semibold inline-flex items-center justify-center">
                <i data-lucide="download" class="h-4 w-4 mr-2"></i>
                Download PDF (Client)
            </button>
            <a href="/search-trains" class="btn-secondary px-8 py-3 rounded-lg font-semibold inline-flex items-center justify-center">
                <i data-lucide="search" class="h-4 w-4 mr-2"></i>
                Book Another Ticket
            </a>
        </div>


        
        <div class="mt-4 p-4 rounded-lg no-print" style="background-color: rgba(255, 255, 0, 0.1); border: 1px solid #ffd700; display: none;" id="debugInfo">
            <div class="flex items-start gap-3">
                <i data-lucide="bug" class="h-5 w-5 mt-0.5" style="color: #ffd700;"></i>
                <div>
                    <p class="text-sm font-semibold mb-1" style="color: #ffd700;">Debug Information:</p>
                    <div class="text-xs space-y-1" style="color: #848484;">
                        <p><strong>jsPDF Library:</strong> <span id="jspdfStatus">Checking...</span></p>
                        <p><strong>Booking Data:</strong> <span id="bookingDataStatus">Loading...</span></p>
                        <p><strong>Print Function:</strong> <span id="printStatus">Ready</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Booking data for JavaScript
        const bookingData = {
            id: /*[[${booking.id}]]*/ '12345',
            username: /*[[${booking.user.username}]]*/ 'john_doe',
            trainName: /*[[${booking.schedule.train.name}]]*/ 'Express Train',
            routeName: /*[[${booking.schedule.route.name}]]*/ 'Colombo to Kandy',
            seatNumber: /*[[${booking.seatNumber}]]*/ 'A12',
            departureDate: /*[[${#temporals.format(booking.schedule.departureDate, 'MMM dd, yyyy HH:mm')}]]*/ 'Dec 25, 2024 08:30',
            arrivalDate: /*[[${#temporals.format(booking.schedule.arrivalDate, 'MMM dd, yyyy HH:mm')}]]*/ 'Dec 25, 2024 11:00',
            fare: /*[[${booking.fare}]]*/ '25.00',
            status: /*[[${booking.status}]]*/ 'CONFIRMED'
        };

        // Print ticket function
        function printTicket() {
            console.log('Print ticket function called');
            window.print();
        }

        // Download PDF function
        function downloadPDF() {
            console.log('Download PDF function called');
            console.log('Booking data:', bookingData);
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.text('RailLink Train Ticket', 20, 20);
                
                // Add booking details
                doc.setFontSize(12);
                doc.text('Booking ID: #' + bookingData.id, 20, 40);
                doc.text('Passenger: ' + bookingData.username, 20, 50);
                doc.text('Train: ' + bookingData.trainName, 20, 60);
                doc.text('Route: ' + bookingData.routeName, 20, 70);
                doc.text('Seat: ' + bookingData.seatNumber, 20, 80);
                doc.text('Departure: ' + bookingData.departureDate, 20, 90);
                doc.text('Arrival: ' + bookingData.arrivalDate, 20, 100);
                doc.text('Fare: $' + bookingData.fare, 20, 110);
                doc.text('Status: ' + bookingData.status, 20, 120);
                
                // Add footer
                doc.setFontSize(10);
                doc.text('Valid for this journey only. Please arrive 15 minutes early.', 20, 140);
                doc.text('Generated on: ' + new Date().toLocaleString(), 20, 150);
                
                // Save the PDF
                doc.save('ticket-' + bookingData.id + '.pdf');
                console.log('PDF generated successfully');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            }
        }

        // Test if jsPDF is loaded and update debug info
        window.addEventListener('load', function() {
            // Update debug information
            const jspdfStatus = document.getElementById('jspdfStatus');
            const bookingDataStatus = document.getElementById('bookingDataStatus');
            
            if (typeof window.jspdf === 'undefined') {
                console.error('jsPDF library not loaded');
                if (jspdfStatus) jspdfStatus.textContent = 'Not loaded';
                if (jspdfStatus) jspdfStatus.style.color = '#ef4444';
            } else {
                console.log('jsPDF library loaded successfully');
                if (jspdfStatus) jspdfStatus.textContent = 'Loaded successfully';
                if (jspdfStatus) jspdfStatus.style.color = '#22c55e';
            }
            
            // Check booking data
            if (bookingData && bookingData.id) {
                if (bookingDataStatus) bookingDataStatus.textContent = 'Loaded successfully';
                if (bookingDataStatus) bookingDataStatus.style.color = '#22c55e';
            } else {
                if (bookingDataStatus) bookingDataStatus.textContent = 'Failed to load';
                if (bookingDataStatus) bookingDataStatus.style.color = '#ef4444';
            }
            
            // Show debug info if there are any issues
            if (typeof window.jspdf === 'undefined' || !bookingData || !bookingData.id) {
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) debugInfo.style.display = 'block';
            }
        });
    </script>
</body>
</html>


